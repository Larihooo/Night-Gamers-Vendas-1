<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - Night Gamers</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>
<body>
    <nav><a href="index.html">⬅ Voltar para a Loja</a></nav>

    <div class="container" style="max-width: 600px;">
        <div id="produto-info" class="card" style="margin-bottom: 20px; text-align: center; border-bottom: 2px solid var(--primary);">
            </div>

        <div id="paymentBrick_container"></div>
    </div>

    <script type="module">
        import { db } from './firebase.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        let produto = null;

        // 1. INICIALIZAR MERCADO PAGO COM SUA PUBLIC KEY
        const mp = new MercadoPago('APP_USR-3ea70421-3dea-4d05-ba72-120110ed6365'); 
        const bricksBuilder = mp.bricks();

        async function carregarProduto() {
            const snap = await getDoc(doc(db, "produtos", id));
            if(!snap.exists()) {
                alert("Produto não encontrado!");
                window.location.href = "index.html";
                return;
            }
            produto = snap.data();

            document.getElementById('produto-info').innerHTML = `
                <img src="${produto.imagem}" style="width:100px; height:100px; object-fit:cover; border-radius:15px; margin-bottom:10px">
                <h3>${produto.nome}</h3>
                <h2 style="color:var(--accent)">R$ ${produto.preco}</h2>
            `;
            
            renderCheckout();
        }

        const renderCheckout = async () => {
            const settings = {
                initialization: {
                    amount: parseFloat(produto.preco),
                    payer: { email: "" },
                },
                customization: {
                    visual: {
                        style: { theme: 'dark' }
                    },
                    paymentMethods: {
                        creditCard: 'all',
                        pix: 'all',
                        maxInstallments: 1
                    }
                },
                callbacks: {
                    onReady: () => { console.log("Checkout pronto!") },
                    onSubmit: ({ selectedPaymentMethod, formData }) => {
                        return new Promise((resolve, reject) => {
                            processarPagamento(formData)
                                .then(() => resolve())
                                .catch((error) => {
                                    alert("Erro: " + error);
                                    reject();
                                });
                        });
                    },
                    onError: (error) => { console.error("Erro no Brick:", error) },
                },
            };
            window.paymentBrickController = await bricksBuilder.create('payment', 'paymentBrick_container', settings);
        };

        async function processarPagamento(formData) {
            // SEU ACCESS TOKEN
            const ACCESS_TOKEN = "APP_USR-6959306902120043-012021-db4a82787f589fbe871162d1119c6506-1698285173";

            // Corpo da requisição para o Mercado Pago
            const paymentData = {
                transaction_amount: formData.transaction_amount,
                token: formData.token,
                description: produto.nome,
                installments: formData.installments,
                payment_method_id: formData.payment_method_id,
                issuer_id: formData.issuer_id,
                payer: {
                    email: formData.payer.email,
                    identification: {
                        type: formData.payer.identification.type,
                        number: formData.payer.identification.number
                    }
                }
            };

            const response = await fetch("https://api.mercadopago.com/v1/payments", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${ACCESS_TOKEN}`
                },
                body: JSON.stringify(paymentData)
            });

            const result = await response.json();

            if (result.status === "approved") {
                // REDIRECIONA PARA SUCESSO E PASSA O CONTEÚDO DIGITAL
                window.location.href = `sucesso.html?entrega=${encodeURIComponent(produto.entrega)}`;
            } else if (result.status === "pending" && formData.payment_method_id === "pix") {
                // PARA PIX, PRECISAMOS MOSTRAR O QR CODE (Caso queira simplificar, avise o usuário)
                const qrCode = result.point_of_interaction.transaction_data.qr_code;
                alert("Pix Gerado! Copie o código: " + qrCode);
                // Aqui você poderia criar um modal para mostrar o QR Code
            } else {
                alert("Pagamento não aprovado. Status: " + (result.status_detail || "Erro desconhecido"));
            }
        }

        carregarProduto();
    </script>
</body>
</html>