<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Finalizar Compra</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>
<body>
    <nav><a href="index.html" style="color:white">⬅ Voltar</a></nav>

    <div id="modal-pix">
        <div class="card" style="text-align:center; max-width:350px;">
            <h3 style="color:var(--primary)">Pagamento via PIX</h3>
            <div id="qr-area"></div>
            <div id="pix-texto" style="font-size:0.7rem; background:#000; padding:10px; margin:10px 0; word-break:break-all"></div>
            <button onclick="copiarPix()">Copiar Código</button>
            <p style="font-size:0.8rem; margin-top:15px">Aguardando pagamento...</p>
        </div>
    </div>

    <div class="container" style="max-width:500px">
        <div id="prod-info" class="card" style="text-align:center"></div>
        
        <div class="card">
            <label>E-mail para entrega:</label>
            <input type="email" id="email-cliente" placeholder="seu@email.com">
            <div id="walletBrick_container"></div>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        const mp = new MercadoPago('APP_USR-3ea70421-3dea-4d05-ba72-120110ed6365');
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        let produto = null;

        async function carregar() {
            const snap = await getDoc(doc(db, "produtos", id));
            if(!snap.exists()) return;
            produto = snap.data();
            document.getElementById('prod-info').innerHTML = `<h3>${produto.nome}</h3><h2>R$ ${produto.preco}</h2>`;
            renderBrick();
        }

        async function renderBrick() {
            const bricksBuilder = mp.bricks();
            await bricksBuilder.create('payment', 'walletBrick_container', {
                initialization: { amount: parseFloat(produto.preco) },
                customization: {
                    paymentMethods: { pix: 'all', creditCard: 'none' },
                    visual: { theme: 'dark' }
                },
                callbacks: {
                    onReady: () => {},
                    onError: (err) => console.error(err),
                    onSubmit: ({ formData }) => {
                        const email = document.getElementById('email-cliente').value;
                        if(!email.includes('@')) return alert("E-mail inválido");
                        formData.payer.email = email;
                        return enviarPagamento(formData);
                    }
                }
            });
        }

        async function enviarPagamento(dados) {
            const res = await fetch("https://api.mercadopago.com/v1/payments", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "Authorization": "Bearer APP_USR-6959306902120043-012021-db4a82787f589fbe871162d1119c6506-1698285173" 
                },
                body: JSON.stringify({
                    transaction_amount: dados.transaction_amount,
                    description: produto.nome,
                    payment_method_id: "pix",
                    payer: { email: dados.payer.email }
                })
            });
            const data = await res.json();
            if(data.point_of_interaction) {
                document.getElementById('qr-area').innerHTML = `<img src="data:image/png;base64,${data.point_of_interaction.transaction_data.qr_code_base64}" style="width:200px">`;
                document.getElementById('pix-texto').innerText = data.point_of_interaction.transaction_data.qr_code;
                document.getElementById('modal-pix').style.display = 'flex';
                checarStatus(data.id);
            }
        }

        function checarStatus(pid) {
            setInterval(async () => {
                const res = await fetch(`https://api.mercadopago.com/v1/payments/${pid}`, {
                    headers: { "Authorization": "Bearer APP_USR-6959306902120043-012021-db4a82787f589fbe871162d1119c6506-1698285173" }
                });
                const r = await res.json();
                if(r.status === "approved") window.location.href = `sucesso.html?entrega=${encodeURIComponent(produto.entrega)}`;
            }, 3000);
        }

        window.copiarPix = () => {
            navigator.clipboard.writeText(document.getElementById('pix-texto').innerText);
            alert("Copiado!");
        }

        carregar();
    </script>
</body>
</html>