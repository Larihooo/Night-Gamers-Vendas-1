<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento PIX - Night Gamers</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        #modal-pix-entrega {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 99999; justify-content: center; align-items: center;
        }
        .pix-container-box {
            background: #111827; padding: 25px; border-radius: 15px; text-align: center; 
            max-width: 350px; width: 90%; border: 2px solid #6366f1; color: white;
        }
        .qr-img { width: 200px; height: 200px; margin: 15px auto; background: white; padding: 10px; border-radius: 8px; }
        .pix-code-text { background: #000; padding: 10px; border-radius: 5px; font-size: 0.7rem; word-break: break-all; margin-bottom: 15px; border: 1px solid #333; }
        .load-spin { border: 3px solid #333; border-top: 3px solid #6366f1; border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .input-email { width: 100%; padding: 12px; margin-top: 8px; background: #1f2937; border: 1px solid #374151; color: white; border-radius: 8px; }
    </style>
</head>
<body>
    <nav><a href="index.html" style="color:white; text-decoration:none">⬅ Voltar</a></nav>

    <div id="modal-pix-entrega">
        <div class="pix-container-box">
            <h3 style="color:#6366f1">Pagamento via PIX</h3>
            <div id="area-qrcode"></div>
            <p style="font-size: 0.8rem">Escaneie o QR Code ou copie abaixo:</p>
            <div class="pix-code-text" id="texto-pix">Gerando...</div>
            <button onclick="copiarPixChave()" style="background:#6366f1; width: 100%; margin-bottom: 10px;">Copiar Código</button>
            <div class="load-spin"></div>
            <p style="font-size: 0.7rem; color: #9ca3af;">Aguardando confirmação do pagamento...</p>
        </div>
    </div>

    <div class="container" style="max-width: 500px; padding-top: 20px;">
        <div id="info-p" class="card" style="text-align: center; margin-bottom: 20px;"></div>
        
        <div class="card" style="margin-bottom: 20px;">
            <label style="font-size: 0.9rem;">E-mail para entrega:</label>
            <input type="email" id="email-entrega" class="input-email" placeholder="seu@email.com">
            <p style="font-size: 0.7rem; color: #9ca3af; margin-top: 5px;">* O PIX só será gerado com um e-mail válido.</p>
        </div>

        <div id="container-mp-brick"></div>
    </div>

    <script type="module">
        import { db } from './firebase.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        const PUB_KEY = 'APP_USR-3ea70421-3dea-4d05-ba72-120110ed6365';
        const TOKEN_SEC = 'APP_USR-6959306902120043-012021-db4a82787f589fbe871162d1119c6506-1698285173';

        const params = new URLSearchParams(window.location.search);
        const prodId = params.get('id');
        let prodDados = null;

        const mpInstance = new MercadoPago(PUB_KEY);
        const bricks = mpInstance.bricks();

        async function iniciar() {
            const snap = await getDoc(doc(db, "produtos", prodId));
            if(!snap.exists()) return;
            prodDados = snap.data();
            document.getElementById('info-p').innerHTML = `<h3>${prodDados.nome}</h3><h2 style="color:#6366f1">R$ ${prodDados.preco}</h2>`;
            montarCheckout();
        }

        const montarCheckout = async () => {
            await bricks.create('payment', 'container-mp-brick', {
                initialization: { amount: parseFloat(prodDados.preco) },
                customization: {
                    paymentMethods: { pix: 'all', creditCard: 'none', ticket: 'none', bankTransfer: 'none' },
                    visual: { theme: 'dark' }
                },
                callbacks: {
                    onSubmit: ({ formData }) => {
                        const email = document.getElementById('email-entrega').value;
                        if(!email || !email.includes('@')) return alert("Digite um e-mail válido!");
                        formData.payer.email = email;
                        return new Promise((resolve, reject) => {
                            chamadaPagamento(formData).then(resolve).catch(reject);
                        });
                    }
                }
            });
        };

        async function chamadaPagamento(dadosForm) {
            const res = await fetch("https://api.mercadopago.com/v1/payments", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${TOKEN_SEC}` },
                body: JSON.stringify({
                    transaction_amount: dadosForm.transaction_amount,
                    description: prodDados.nome,
                    payment_method_id: "pix",
                    payer: { email: dadosForm.payer.email }
                })
            });
            const final = await res.json();
            if (final.status === "pending" || final.status === "approved") {
                if(final.status === "approved") {
                    window.location.href = `sucesso.html?entrega=${encodeURIComponent(prodDados.entrega)}`;
                } else {
                    abrirModalPix(final);
                }
            } else {
                alert("Erro ao gerar PIX. Verifique se o e-mail está correto.");
            }
        }

        function abrirModalPix(dados) {
            document.getElementById('area-qrcode').innerHTML = `<img src="data:image/png;base64,${dados.point_of_interaction.transaction_data.qr_code_base64}" class="qr-img">`;
            document.getElementById('texto-pix').innerText = dados.point_of_interaction.transaction_data.qr_code;
            document.getElementById('modal-pix-entrega').style.display = 'flex';
            loopStatus(dados.id);
        }

        async function loopStatus(idPg) {
            const t = setInterval(async () => {
                const r = await fetch(`https://api.mercadopago.com/v1/payments/${idPg}`, {
                    headers: { "Authorization": `Bearer ${TOKEN_SEC}` }
                });
                const d = await r.json();
                if (d.status === "approved") {
                    clearInterval(t);
                    window.location.href = `sucesso.html?entrega=${encodeURIComponent(prodDados.entrega)}`;
                }
            }, 3000);
        }

        window.copiarPixChave = () => {
            navigator.clipboard.writeText(document.getElementById('texto-pix').innerText);
            alert("Copiado!");
        };

        iniciar();
    </script>
</body>
</html>