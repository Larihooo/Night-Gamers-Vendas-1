<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento PIX - Night Gamers</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        #pix-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center;
        }
        .pix-box {
            background: #1e293b; padding: 30px; border-radius: 20px; text-align: center; 
            max-width: 400px; width: 90%; border: 2px solid var(--accent);
        }
        .qr-code-img { width: 220px; height: 220px; margin: 20px auto; background: white; padding: 10px; border-radius: 10px; }
        .copy-box { background: #0f172a; padding: 12px; border-radius: 8px; font-size: 0.8rem; word-break: break-all; margin: 15px 0; border: 1px solid #334155; color: #fff; }
        .loader { border: 4px solid #334155; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <nav><a href="index.html">⬅ Voltar</a></nav>

    <div id="pix-modal">
        <div class="pix-box">
            <h3 style="color:var(--accent)">Pagamento via PIX</h3>
            <div id="qr-container"></div>
            <p>Escaneie ou copie o código:</p>
            <div class="copy-box" id="pix-code">Gerando...</div>
            <button onclick="copyPix()" style="background:var(--primary); margin-bottom: 10px;">Copiar Código PIX</button>
            <div class="loader"></div>
            <p style="font-size: 0.8rem; color: #94a3b8;">Aguardando aprovação...</p>
        </div>
    </div>

    <div class="container" style="max-width: 500px;">
        <div id="produto-info" class="card" style="text-align: center; margin-bottom: 20px;"></div>
        
        <div class="card" style="margin-bottom: 20px;">
            <label>Informe seu e-mail para receber o comprovante:</label>
            <input type="email" id="email-pagador" placeholder="seu@email.com" style="width:100%; padding:10px; margin-top:10px; background:#0f172a; color:white; border:1px solid #334155; border-radius:8px;">
        </div>

        <div id="paymentBrick_container"></div>
    </div>

    <script type="module">
        import { db } from './firebase.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        const PUBLIC_KEY = 'APP_USR-3ea70421-3dea-4d05-ba72-120110ed6365';
        const ACCESS_TOKEN = 'APP_USR-6959306902120043-012021-db4a82787f589fbe871162d1119c6506-1698285173';

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        let produto = null;

        const mp = new MercadoPago(PUBLIC_KEY);
        const bricksBuilder = mp.bricks();

        async function carregar() {
            const snap = await getDoc(doc(db, "produtos", id));
            if(!snap.exists()) return;
            produto = snap.data();
            document.getElementById('produto-info').innerHTML = `<h3>${produto.nome}</h3><h2 style="color:var(--accent)">R$ ${produto.preco}</h2>`;
            renderCheckout();
        }

        const renderCheckout = async () => {
            const settings = {
                initialization: {
                    amount: parseFloat(produto.preco),
                },
                customization: {
                    paymentMethods: {
                        pix: 'all',
                        // Desativamos cartões para teste forçado
                        creditCard: 'none', 
                        ticket: 'none',
                        bankTransfer: 'none'
                    },
                    visual: { theme: 'dark' }
                },
                callbacks: {
                    onSubmit: ({ formData }) => {
                        // Pegamos o email digitado pelo usuário
                        const emailUser = document.getElementById('email-pagador').value;
                        if(!emailUser.includes('@')) {
                            alert("Por favor, insira um e-mail válido.");
                            return;
                        }
                        formData.payer.email = emailUser;
                        return new Promise((resolve, reject) => {
                            processarPagamento(formData).then(resolve).catch(reject);
                        });
                    }
                }
            };
            window.paymentBrickController = await bricksBuilder.create('payment', 'paymentBrick_container', settings);
        };

        async function processarPagamento(formData) {
            const response = await fetch("https://api.mercadopago.com/v1/payments", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${ACCESS_TOKEN}` },
                body: JSON.stringify({
                    transaction_amount: formData.transaction_amount,
                    description: produto.nome,
                    payment_method_id: "pix",
                    payer: { email: formData.payer.email }
                })
            });

            const result = await response.json();

            if (result.status === "pending" || result.status === "approved") {
                if(result.status === "approved") {
                    window.location.href = `sucesso.html?entrega=${encodeURIComponent(produto.entrega)}`;
                } else {
                    exibirPix(result);
                }
            } else {
                alert("Erro ao gerar PIX: " + (result.message || "Verifique suas credenciais"));
            }
        }

        function exibirPix(data) {
            const modal = document.getElementById('pix-modal');
            const qrImg = data.point_of_interaction.transaction_data.qr_code_base64;
            const qrText = data.point_of_interaction.transaction_data.qr_code;
            document.getElementById('qr-container').innerHTML = `<img src="data:image/png;base64,${qrImg}" class="qr-code-img">`;
            document.getElementById('pix-code').innerText = qrText;
            modal.style.display = 'flex';
            verificarStatus(data.id);
        }

        async function verificarStatus(idPagamento) {
            const checar = setInterval(async () => {
                const res = await fetch(`https://api.mercadopago.com/v1/payments/${idPagamento}`, {
                    headers: { "Authorization": `Bearer ${ACCESS_TOKEN}` }
                });
                const info = await res.json();
                if (info.status === "approved") {
                    clearInterval(checar);
                    window.location.href = `sucesso.html?entrega=${encodeURIComponent(produto.entrega)}`;
                }
            }, 3000);
        }

        window.copyPix = () => {
            navigator.clipboard.writeText(document.getElementById('pix-code').innerText);
            alert("Copiado!");
        };

        carregar();
    </script>
</body>
</html>