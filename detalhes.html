<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Night Gamers</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        /* Estilos do Modal do PIX */
        #pix-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center;
        }
        .pix-box {
            background: #1e293b; padding: 30px; border-radius: 20px; text-align: center; 
            max-width: 400px; width: 90%; border: 2px solid var(--primary);
        }
        .qr-code-img { width: 220px; height: 220px; margin: 20px auto; background: white; padding: 10px; border-radius: 10px; }
        .copy-box { background: #0f172a; padding: 12px; border-radius: 8px; font-size: 0.8rem; word-break: break-all; margin: 15px 0; border: 1px solid #334155; color: #fff; }
        .loader { border: 4px solid #334155; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <nav><a href="index.html">⬅ Voltar para a Loja</a></nav>

    <div id="pix-modal">
        <div class="pix-box">
            <h3 style="color:var(--accent)">Pagamento via PIX</h3>
            <div id="qr-container"></div>
            <p style="font-size: 0.9rem;">Escaneie o QR Code ou copie o código:</p>
            <div class="copy-box" id="pix-code">Gerando código...</div>
            <button onclick="copyPix()" style="background:var(--primary); margin-bottom: 15px;">Copiar Código PIX</button>
            <div class="loader"></div>
            <p style="font-size: 0.8rem; color: #94a3b8;">Aguardando aprovação do banco...</p>
        </div>
    </div>

    <div class="container" style="max-width: 600px;">
        <div id="produto-info" class="card" style="text-align: center; margin-bottom: 20px;">
            </div>

        <div id="paymentBrick_container"></div>
    </div>

    <script type="module">
        import { db } from './firebase.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // CONFIGURAÇÕES
        const PUBLIC_KEY = 'APP_USR-3ea70421-3dea-4d05-ba72-120110ed6365';
        const ACCESS_TOKEN = 'APP_USR-6959306902120043-012021-db4a82787f589fbe871162d1119c6506-1698285173';

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        let produto = null;

        const mp = new MercadoPago(PUBLIC_KEY);
        const bricksBuilder = mp.bricks();

        async function carregar() {
            const snap = await getDoc(doc(db, "produtos", id));
            if(!snap.exists()) return;
            produto = snap.data();
            
            document.getElementById('produto-info').innerHTML = `
                <img src="${produto.imagem}" style="width:80px; height:80px; object-fit:cover; border-radius:10px">
                <h3>${produto.nome}</h3>
                <h2 style="color:var(--accent)">R$ ${produto.preco}</h2>
            `;
            renderCheckout();
        }

        const renderCheckout = async () => {
            const settings = {
                initialization: {
                    amount: parseFloat(produto.preco),
                    payer: { email: "cliente@exemplo.com" } // Email padrão ajuda o PIX a aparecer
                },
                customization: {
                    visual: { theme: 'dark' },
                    paymentMethods: {
                        creditCard: 'all',
                        pix: 'all',
                        maxInstallments: 1
                    }
                },
                callbacks: {
                    onReady: () => console.log("Checkout Pronto"),
                    onSubmit: ({ formData }) => {
                        return new Promise((resolve, reject) => {
                            processarPagamento(formData).then(resolve).catch(reject);
                        });
                    },
                    onError: (err) => console.error(err)
                }
            };
            window.paymentBrickController = await bricksBuilder.create('payment', 'paymentBrick_container', settings);
        };

        async function processarPagamento(formData) {
            const response = await fetch("https://api.mercadopago.com/v1/payments", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "Authorization": `Bearer ${ACCESS_TOKEN}` 
                },
                body: JSON.stringify({
                    transaction_amount: formData.transaction_amount,
                    token: formData.token,
                    description: produto.nome,
                    installments: formData.installments,
                    payment_method_id: formData.payment_method_id,
                    issuer_id: formData.issuer_id,
                    payer: formData.payer
                })
            });

            const result = await response.json();

            if (result.status === "approved") {
                window.location.href = `sucesso.html?entrega=${encodeURIComponent(produto.entrega)}`;
            } 
            else if (result.status === "pending" && formData.payment_method_id === "pix") {
                exibirPix(result);
            } 
            else {
                alert("Erro: " + (result.status_detail || "Pagamento Recusado"));
            }
        }

        function exibirPix(data) {
            const modal = document.getElementById('pix-modal');
            const qrImg = data.point_of_interaction.transaction_data.qr_code_base64;
            const qrText = data.point_of_interaction.transaction_data.qr_code;

            document.getElementById('qr-container').innerHTML = `<img src="data:image/png;base64,${qrImg}" class="qr-code-img">`;
            document.getElementById('pix-code').innerText = qrText;
            modal.style.display = 'flex';

            // Inicia verificação automática (Polling)
            verificarStatus(data.id);
        }

        async function verificarStatus(idPagamento) {
            const checar = setInterval(async () => {
                const res = await fetch(`https://api.mercadopago.com/v1/payments/${idPagamento}`, {
                    headers: { "Authorization": `Bearer ${ACCESS_TOKEN}` }
                });
                const info = await res.json();
                
                if (info.status === "approved") {
                    clearInterval(checar);
                    window.location.href = `sucesso.html?entrega=${encodeURIComponent(produto.entrega)}`;
                }
            }, 3000);
        }

        window.copyPix = () => {
            const text = document.getElementById('pix-code').innerText;
            navigator.clipboard.writeText(text);
            alert("Código PIX copiado!");
        };

        carregar();
    </script>
</body>
</html>