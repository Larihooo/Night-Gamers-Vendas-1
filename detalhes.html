<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Night Gamers</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        /* Estilo para o Modal do PIX */
        #pix-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center;
        }
        .pix-box {
            background: #1e293b; padding: 30px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%;
            border: 1px solid var(--primary);
        }
        .qr-code-img { width: 200px; height: 200px; margin: 20px auto; background: white; padding: 10px; border-radius: 10px; }
        .copy-box { background: #0f172a; padding: 10px; border-radius: 8px; font-size: 0.8rem; word-break: break-all; margin: 15px 0; border: 1px solid #334155; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <nav><a href="index.html">⬅ Voltar</a></nav>

    <div id="pix-modal">
        <div class="pix-box">
            <h3>Escaneie o QR Code</h3>
            <div id="qr-container"></div>
            <p>Ou copie o código abaixo:</p>
            <div class="copy-box" id="pix-code">Carregando código...</div>
            <button onclick="copyPix()" style="background:var(--primary)">Copiar Código PIX</button>
            <div class="loader"></div>
            <p style="font-size: 0.8rem; color: #94a3b8;">Aguardando pagamento... (Não feche esta tela)</p>
        </div>
    </div>

    <div class="container" style="max-width: 600px;">
        <div id="produto-info" class="card" style="text-align: center;"></div>
        <div id="paymentBrick_container"></div>
    </div>

    <script type="module">
        import { db } from './firebase.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        const ACCESS_TOKEN = "APP_USR-6959306902120043-012021-db4a82787f589fbe871162d1119c6506-1698285173";
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        let produto = null;

        const mp = new MercadoPago('APP_USR-3ea70421-3dea-4d05-ba72-120110ed6365'); 
        const bricksBuilder = mp.bricks();

        async function carregar() {
            const snap = await getDoc(doc(db, "produtos", id));
            if(!snap.exists()) return;
            produto = snap.data();
            document.getElementById('produto-info').innerHTML = `<h3>${produto.nome}</h3><h2>R$ ${produto.preco}</h2>`;
            renderCheckout();
        }

        const renderCheckout = async () => {
            const settings = {
                initialization: { amount: parseFloat(produto.preco), payer: { email: "teste@email.com" } },
                customization: { visual: { theme: 'dark' }, paymentMethods: { creditCard: 'all', pix: 'all' } },
                callbacks: {
                    onSubmit: ({ formData }) => {
                        return new Promise((resolve, reject) => {
                            processarPagamento(formData).then(resolve).catch(reject);
                        });
                    }
                }
            };
            await bricksBuilder.create('payment', 'paymentBrick_container', settings);
        };

        async function processarPagamento(formData) {
            const response = await fetch("https://api.mercadopago.com/v1/payments", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${ACCESS_TOKEN}` },
                body: JSON.stringify({
                    transaction_amount: formData.transaction_amount,
                    token: formData.token,
                    description: produto.nome,
                    installments: formData.installments,
                    payment_method_id: formData.payment_method_id,
                    payer: formData.payer
                })
            });

            const result = await response.json();

            if (result.status === "approved") {
                window.location.href = `sucesso.html?entrega=${encodeURIComponent(produto.entrega)}`;
            } 
            else if (result.status === "pending" && formData.payment_method_id === "pix") {
                mostrarPix(result);
            } else {
                alert("Pagamento recusado: " + result.status_detail);
            }
        }

        function mostrarPix(data) {
            const modal = document.getElementById('pix-modal');
            const qrContainer = document.getElementById('qr-container');
            const pixCode = document.getElementById('pix-code');
            
            // Pega o QR Code em imagem e em texto
            const qrImage = data.point_of_interaction.transaction_data.qr_code_base64;
            const qrText = data.point_of_interaction.transaction_data.qr_code;

            qrContainer.innerHTML = `<img src="data:image/png;base64,${qrImage}" class="qr-code-img">`;
            pixCode.innerText = qrText;
            modal.style.display = 'flex';

            // INICIA A VERIFICAÇÃO AUTOMÁTICA (Polling)
            verificarStatus(data.id);
        }

        // Função que fica perguntando ao Mercado Pago se já pagou
        async function verificarStatus(paymentId) {
            const intervalo = setInterval(async () => {
                try {
                    const res = await fetch(`https://api.mercadopago.com/v1/payments/${paymentId}`, {
                        headers: { "Authorization": `Bearer ${ACCESS_TOKEN}` }
                    });
                    const data = await res.json();

                    console.log("Status atual:", data.status);

                    if (data.status === "approved") {
                        clearInterval(intervalo);
                        window.location.href = `sucesso.html?entrega=${encodeURIComponent(produto.entrega)}`;
                    }
                } catch (e) {
                    console.error("Erro ao verificar status");
                }
            }, 3000); // Verifica a cada 3 segundos
        }

        window.copyPix = () => {
            const text = document.getElementById('pix-code').innerText;
            navigator.clipboard.writeText(text);
            alert("Código PIX copiado!");
        };

        carregar();
    </script>
</body>
</html>