<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Admin - Night Gamers</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <a href="index.html">‚¨Ö Voltar</a>
        <span>Gerenciar Invent√°rio</span>
    </nav>

    <div class="container">
        <div class="card" id="form-topo">
            <h3 id="form-title">Novo Produto</h3>
            <input type="text" id="nome" placeholder="Nome do Produto">
            <input type="url" id="img-url" placeholder="Link da Imagem (ImgBB)" oninput="document.getElementById('previa').src=this.value; document.getElementById('previa').style.display='block'">
            <img id="previa" style="width:100%; max-height:150px; object-fit:contain; display:none; margin:10px 0">
            
            <div style="display:flex; gap:10px">
                <input type="number" id="preco" placeholder="Pre√ßo R$">
                <input type="number" id="estoque" placeholder="Qtd Estoque">
            </div>

            <label style="color:var(--accent); font-size:12px">CONTE√öDO PARA ENTREGA (LINK OU CHAVE):</label>
            <textarea id="entrega" placeholder="O que o cliente recebe ap√≥s pagar?" rows="2"></textarea>
            
            <textarea id="desc" placeholder="Descri√ß√£o na loja..." rows="2"></textarea>
            
            <button id="btn-acao" onclick="salvar()">Publicar Produto</button>
            <button id="btn-cancel" onclick="location.reload()" style="display:none; background:#666">Cancelar</button>
        </div>

        <input type="text" id="busca" placeholder="üîç Procurar no meu estoque..." onkeyup="listar()" style="margin-top:30px">
        <div id="lista-admin"></div>
    </div>

    <script type="module">
        import { db, auth, ADMIN_EMAIL } from './firebase.js';
        import { collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        let idEdicao = null;
        let produtos = [];

        window.salvar = async () => {
            const dados = {
                nome: document.getElementById('nome').value,
                preco: document.getElementById('preco').value,
                estoque: parseInt(document.getElementById('estoque').value),
                imagem: document.getElementById('img-url').value,
                entrega: document.getElementById('entrega').value,
                descricao: document.getElementById('desc').value,
                atualizadoEm: new Date()
            };

            if(idEdicao) {
                await updateDoc(doc(db, "produtos", idEdicao), dados);
                alert("Atualizado!");
            } else {
                dados.criadoEm = new Date();
                await addDoc(collection(db, "produtos"), dados);
                alert("Criado!");
            }
            location.reload();
        }

        onSnapshot(query(collection(db, "produtos"), orderBy("criadoEm", "desc")), (snap) => {
            produtos = snap.docs.map(d => ({id: d.id, ...d.data()}));
            listar();
        });

        window.listar = () => {
            const termo = document.getElementById('busca').value.toLowerCase();
            const div = document.getElementById('lista-admin');
            div.innerHTML = "";
            produtos.filter(p => p.nome.toLowerCase().includes(termo)).forEach(p => {
                div.innerHTML += `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:10px">
                    <span>${p.nome} (Qtd: ${p.estoque})</span>
                    <div>
                        <button onclick="editar('${p.id}')" style="width:auto; background:orange; padding:5px">Editar</button>
                        <button onclick="apagar('${p.id}')" style="width:auto; background:red; padding:5px">X</button>
                    </div>
                </div>`;
            });
        }

        window.editar = (id) => {
            const p = produtos.find(x => x.id === id);
            idEdicao = id;
            document.getElementById('nome').value = p.nome;
            document.getElementById('preco').value = p.preco;
            document.getElementById('estoque').value = p.estoque;
            document.getElementById('img-url').value = p.imagem;
            document.getElementById('entrega').value = p.entrega;
            document.getElementById('desc').value = p.descricao;
            document.getElementById('btn-acao').innerText = "Salvar Altera√ß√µes";
            document.getElementById('btn-cancel').style.display = "block";
            window.scrollTo(0,0);
        }

        window.apagar = async (id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, "produtos", id)); }
    </script>
</body>
</html>