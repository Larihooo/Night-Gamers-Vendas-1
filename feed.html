<!DOCTYPE html>
<html lang="pt-br">
<head><meta charset="UTF-8"><link rel="stylesheet" href="style.css"></head>
<body>
    <div class="sidebar">...</div>
    <div class="main-content">
        <div class="main-content">
    <a href="javascript:history.back()" class="btn-voltar">
        ⬅ Voltar
    </a>
    </div>
        <div class="card" style="max-width:600px; margin-bottom:20px">
            <textarea id="msg" placeholder="No que está pensando?" style="width:100%"></textarea>
            <input type="file" id="midia" accept="image/*,video/*">
            <button id="btn-postar">Postar no Feed</button>
        </div>
        <div id="lista-feed" style="max-width:600px"></div>
    </div>
    <script type="module">
        import { db, auth, storage } from './firebase.js?v=1';
        import { collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        document.getElementById('btn-postar').onclick = async () => {
            const user = auth.currentUser;
            if(!user) return alert("Faça login!");
            const file = document.getElementById('midia').files[0];
            let url = "";
            if(file) {
                const r = ref(storage, `feed/${Date.now()}`);
                await uploadBytes(r, file);
                url = await getDownloadURL(r);
            }
            await addDoc(collection(db, "feed"), {
                texto: document.getElementById('msg').value,
                url, user: user.email, data: Date.now(),
                tipo: file?.type.startsWith('video') ? 'v' : 'i'
            });
            location.reload();
        };

        onSnapshot(query(collection(db, "feed"), orderBy("data", "desc")), snap => {
            const l = document.getElementById('lista-feed'); l.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                const m = p.tipo === 'v' ? `<video src="${p.url}" controls style="width:100%">` : (p.url ? `<img src="${p.url}" style="width:100%">` : "");
                l.innerHTML += `<div class="card" style="margin-bottom:15px">
                    <strong>${p.user.split('@')[0]}</strong><p>${p.texto}</p>${m}
                </div>`;
            });
        });
    </script>
</body>
</html>